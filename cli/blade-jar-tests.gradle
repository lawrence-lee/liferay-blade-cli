allprojects {
	tasks.withType(JavaExec) {
		dependsOn jar
	}
}

task testCreateCommand(type: JavaExec)
task testGwCommand(type: JavaExec)
task testHelpCommand(type: JavaExec)
task testInitCommand(type: JavaExec)
task testSamplesCommand(type: JavaExec)
task testVersionCommand(type: JavaExec)

check {
	dependsOn tasks.withType(JavaExec)
}

def errorStream = new ByteArrayOutputStream()
def standardStream = new ByteArrayOutputStream()

testCreateCommand {
	args = [jar.archivePath, 'create', '-l']
	errorOutput = errorStream
	main = '-jar'
	standardOutput = standardStream

	doLast{
		assert standardStream.toString().contains("service-builder")
		assert !errorStream.toString().toLowerCase().contains("error")
	}
}

testGwCommand {
	args = [jar.archivePath, 'gw']
	errorOutput = errorStream
	main = '-jar'
	standardOutput = standardStream

	doLast{
		assert standardStream.toString().contains(gradle.gradleVersion)
		assert !errorStream.toString().toLowerCase().contains("error")
	}
}

testHelpCommand {
	args = [jar.archivePath, 'help']
	errorOutput = errorStream
	main = '-jar'
	standardOutput = standardStream

	doLast{
		assert standardStream.toString().contains("init")
		assert !errorStream.toString().toLowerCase().contains("error")
	}
}

testInitCommand {
	File initDir = new File(buildDir, "initTest")

	initDir.mkdirs()

	args = [jar.archivePath, 'init', "hello world"]
	errorOutput = errorStream
	main = '-jar'
	standardOutput = standardStream
	workingDir = initDir

	doLast{
		File initProjectDir = new File(initDir, "hello world")

		assert initProjectDir.exists()
		assert !errorStream.toString().toLowerCase().contains("error")

		delete initDir
	}
}

testSamplesCommand {
	args = [jar.archivePath, 'samples']
	main = '-jar'
	standardOutput = standardStream
	errorOutput = errorStream

	doLast{
		assert standardStream.toString().contains("jsp-portlet")
		assert !errorStream.toString().toLowerCase().contains("error")
	}
}

testVersionCommand {
	args = [jar.archivePath, 'version']
	main = '-jar'
	standardOutput = standardStream
	errorOutput = errorStream

	doLast{
		String projectVersion = project.version.replaceFirst("-", ".")
		assert !errorStream.toString().toLowerCase().contains("error")
		assert standardStream.toString().contains(projectVersion)
	}
}